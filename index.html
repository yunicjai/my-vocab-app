<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>éŸ“æ—¥é›™èªå­¸ç¿’</title>
    <style>
        :root { --primary: #5c67f2; --bg: #f0f2f5; --jp-color: #ff7675; --kr-color: #5c67f2; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; padding-bottom: 90px; text-align: center; color: #333; }
        
        .lang-switcher { background: #2d3436; padding: 12px; display: flex; flex-direction: column; align-items: center; gap: 10px; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .lang-btn-row { display: flex; gap: 10px; }
        .lang-btn { background: #636e72; color: white; border: none; padding: 8px 18px; border-radius: 20px; cursor: pointer; font-size: 0.85rem; font-weight: bold; transition: 0.2s; }
        .lang-btn.active.kr { background: var(--kr-color); transform: scale(1.05); box-shadow: 0 0 10px rgba(92,103,242,0.4); }
        .lang-btn.active.jp { background: var(--jp-color); transform: scale(1.05); box-shadow: 0 0 10px rgba(255,118,117,0.4); }
        
        #cat-selector { background: #fff; color: #333; border-radius: 10px; padding: 6px 12px; border: none; font-size: 0.85rem; width: 85%; max-width: 320px; outline: none; font-weight: bold; }

        .container { padding: 15px; max-width: 500px; margin: 0 auto; }
        .card { background: white; padding: 20px; border-radius: 18px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); margin-bottom: 20px; }
        
        .display-box { font-size: 2.2rem; min-height: 70px; margin: 15px 0; border: 3px solid #eee; border-radius: 15px; padding: 10px; color: var(--primary); display: flex; justify-content: center; align-items: center; background: #fafafa; transition: all 0.3s; letter-spacing: 2px; }

        .keyboard { background: #dfe6e9; padding: 12px; border-radius: 15px; }
        .key-row { display: flex; justify-content: center; flex-wrap: wrap; gap: 6px; margin-bottom: 8px; }
        .k-btn { background: white; color: #2d3436; border: 1px solid #b2bec3; border-bottom: 3px solid #b2bec3; padding: 10px 0; width: 42px; border-radius: 8px; font-size: 1.1rem; font-weight: bold; cursor: pointer; }
        .k-btn:active { transform: translateY(2px); border-bottom: 1px solid #b2bec3; background: var(--primary); color: white; }

        .choice-btn { background: #f9f9ff; color: var(--primary); border: 2px solid #eef0ff; font-size: 1.3rem; min-width: 55px; padding: 12px; border-radius: 12px; font-weight: bold; cursor: pointer; margin: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: 0.1s; }
        .choice-btn:active { transform: scale(0.95); background: var(--primary); color: white; }

        .nav { background: white; padding: 10px 0; display: flex; justify-content: space-around; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); position: fixed; bottom: 0; width: 100%; z-index: 999; }
        .nav-btn { cursor: pointer; color: #b2bec3; font-size: 0.8rem; display: flex; flex-direction: column; align-items: center; text-decoration: none; font-weight: bold; transition: 0.2s; }
        .nav-btn.active { color: var(--primary); }
        .nav-icon { font-size: 1.4rem; margin-bottom: 2px; }

        button { background: var(--primary); color: white; border: none; padding: 12px 20px; border-radius: 12px; cursor: pointer; font-weight: bold; font-size: 1rem; }
        .hidden { display: none; }
        .word-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #eee; text-align: left; }
    </style>
</head>
<body>

    <div class="lang-switcher">
        <div class="lang-btn-row">
            <button class="lang-btn active kr" id="lang-kr" onclick="changeLang('kr')">ğŸ‡°ğŸ‡· éŸ“æ–‡</button>
            <button class="lang-btn jp" id="lang-jp" onclick="changeLang('jp')">ğŸ‡¯ğŸ‡µ æ—¥æ–‡</button>
        </div>
        <select id="cat-selector" onchange="filterByCategory()">
            <option value="all">ğŸ“ å…¨éƒ¨å–®å­—</option>
        </select>
    </div>

    <div class="container">
        <div class="card" style="padding: 10px;">
            <button onclick="fetchData()" style="width: 100%; background: #636e72;">ğŸ”„ åŒæ­¥è³‡æ–™èˆ‡åˆ†é¡</button>
            <div id="status" style="font-size: 0.75rem; margin-top: 5px; color: #888;">è«‹å…ˆé»æ“ŠåŒæ­¥</div>
        </div>

        <div id="page-quiz">
            <div class="card">
                <h3>ğŸ§ è½åŠ›æ¸¬é©— <span id="quiz-cat-tag" style="font-size:0.8rem; color:var(--primary);"></span></h3>
                <button onclick="startQuiz()" style="width:100%; background:#20bf6b; box-shadow: 0 4px 0 #1b9e58;">ğŸ® é–‹å§‹æ¸¬é©—</button>
                <div id="quizArea" class="hidden">
                    <button onclick="speak(targetText)" style="background:#636e72; margin-top:10px; font-size:0.85rem;">ğŸ”Š é‡è½</button>
                    <div id="mainDisplay" class="display-box">???</div>
                    <div class="key-pad" id="choicesPad"></div>
                    <div style="margin-top:20px; display:flex; gap:10px;">
                        <button onclick="userTyped=''; document.getElementById('mainDisplay').innerText='???';" style="flex:1; background:#fab1a0">æ¸…é™¤</button>
                        <button onclick="checkAnswer()" style="flex:2;">æª¢æŸ¥ç­”æ¡ˆ</button>
                    </div>
                    <p id="feedback" style="font-weight:bold; margin-top:10px;"></p>
                </div>
            </div>
        </div>

        <div id="page-spell" class="hidden">
            <div class="card">
                <h3>ğŸ§© æ‹¼å­—æŒ‘æˆ°</h3>
                <button onclick="startSpellQuiz()" style="width:100%; background:#a29bfe; box-shadow: 0 4px 0 #8479e0;">ğŸ® è½éŸ³çµ„å­—</button>
                <div id="spellArea" class="hidden">
                    <button onclick="speak(currentWord.kr)" style="background:#636e72; margin-top:10px; font-size:0.85rem;">ğŸ”Š è½å–®å­—</button>
                    <div id="spellDisplay" class="display-box"></div>
                    <div class="keyboard">
                        <small style="color:#666; display:block; margin-bottom:5px;">å­éŸ³</small>
                        <div class="key-row" id="con-keys"></div>
                        <small style="color:#666; display:block; margin:10px 0 5px;">æ¯éŸ³</small>
                        <div class="key-row" id="vow-keys"></div>
                    </div>
                    <div style="margin-top:20px; display:flex; gap:10px;">
                        <button onclick="spellBuffer=[]; updateSpellUI();" style="flex:1; background:#fab1a0">æ¸…é™¤</button>
                        <button onclick="checkSpell()" style="flex:2;">æª¢æŸ¥æ‹¼å­—</button>
                    </div>
                    <p id="spellFeedback" style="font-weight:bold; margin-top:10px;"></p>
                </div>
            </div>
        </div>

        <div id="page-review" class="hidden"><div class="card"><div id="wordList"></div></div></div>
        <div id="page-auto" class="hidden">
            <div class="card">
                <div id="auto-kr" style="font-size:2.8rem; font-weight:bold; color:var(--primary)"></div>
                <div id="auto-cn" style="font-size:1.2rem; color:#666; margin-top:15px;"></div>
            </div>
            <button id="autoBtn" onclick="toggleAutoplay()" style="width:100%; background:#ff7675;">â–¶ï¸ æ’­æ”¾</button>
        </div>
    </div>

    <div class="nav">
        <div class="nav-btn active" id="nav-quiz" onclick="showPage('quiz')"><span class="nav-icon">ğŸ§</span>æ¸¬é©—</div>
        <div class="nav-btn" id="nav-review" onclick="showPage('review')"><span class="nav-icon">ğŸ“–</span>æ¸…å–®</div>
        <div class="nav-btn" id="nav-auto" onclick="showPage('auto')"><span class="nav-icon">ğŸ”„</span>å¾ªç’°</div>
        <div class="nav-btn" id="nav-spell" onclick="showPage('spell')"><span class="nav-icon">ğŸ§©</span>æ‹¼å­—</div>
    </div>

    <script>
        // ğŸ’¡ ä¿®æ­£äº†ç¶²å€æ–·è¡Œå•é¡Œ
        const GAS_URL = "https://script.google.com/macros/s/AKfycbx-8obNpgBEWiodpefAYnKFxGptbXaTRxre9oQcxTvr6Gjfg2VgMAUYp8g2nv8_gdO_Uw/exec"; 
        
        let allWords = [], filteredWords = [], currentWord = {}, userTyped = "", targetText = "", currentLang = 'kr', isAutoplay = false, autoIndex = 0, autoTimer, spellBuffer = [];
        
        const CHO = ["ã„±","ã„²","ã„´","ã„·","ã„¸","ã„¹","ã…","ã…‚","ã…ƒ","ã……","ã…†","ã…‡","ã…ˆ","ã…‰","ã…Š","ã…‹","ã…Œ","ã…","ã…"];
        const JUNG = ["ã…","ã…","ã…‘","ã…’","ã…“","ã…”","ã…•","ã…–","ã…—","ã…˜","ã…™","ã…š","ã…›","ã…œ","ã…","ã…","ã…Ÿ","ã… ","ã…¡","ã…¢","ã…£"];
        const JONG = ["","ã„±","ã„²","ã„³","ã„´","ã„µ","ã„¶","ã„·","ã„¹","ã„º","ã„»","ã„¼","ã„½","ã„¾","ã„¿","ã…€","ã…","ã…‚","ã…„","ã……","ã…†","ã…‡","ã…ˆ","ã…Š","ã…‹","ã…Œ","ã…","ã…"];
        const COMPLEX_VOWELS = { "ã…—ã…": "ã…˜", "ã…—ã…": "ã…™", "ã…—ã…£": "ã…š", "ã…œã…“": "ã…", "ã…œã…”": "ã…", "ã…œã…£": "ã…Ÿ", "ã…¡ã…£": "ã…¢" };

        async function fetchData() {
            document.getElementById('status').innerText = "â³ åŒæ­¥ä¸­...";
            try {
                const res = await fetch(`${GAS_URL}?lang=${currentLang}&t=${Date.now()}`);
                allWords = await res.json();
                updateCategoryMenu();
                filterByCategory();
                document.getElementById('status').innerText = `âœ… å·²åŒæ­¥ ${allWords.length} å€‹å–®å­—`;
            } catch (e) { document.getElementById('status').innerText = "âŒ åŒå‚™å¤±æ•—ï¼Œè«‹ç¢ºèª GAS ç¶²å€"; }
        }

        function updateCategoryMenu() {
            const menu = document.getElementById('cat-selector');
            const cats = [...new Set(allWords.map(w => w.cat).filter(c => c))];
            menu.innerHTML = '<option value="all">ğŸ“ å…¨éƒ¨å–®å­—</option>' + 
                             cats.map(c => `<option value="${c}">${c}</option>`).join('');
        }

        function filterByCategory() {
            const selected = document.getElementById('cat-selector').value;
            filteredWords = (selected === 'all') ? allWords : allWords.filter(w => String(w.cat) === selected);
            document.getElementById('quiz-cat-tag').innerText = (selected === 'all' ? '' : `[${selected}]`);
            if(!document.getElementById('page-review').classList.contains('hidden')) renderReview();
        }

        function changeLang(l) { 
            currentLang = l; 
            document.getElementById('lang-kr').classList.toggle('active', l==='kr');
            document.getElementById('lang-jp').classList.toggle('active', l==='jp');
            document.documentElement.style.setProperty('--primary', l==='kr' ? '#5c67f2' : '#ff7675');
            fetchData(); 
        }
        
        function showPage(p) {
            stopAutoplay();
            ['quiz', 'review', 'auto', 'spell'].forEach(id => {
                document.getElementById('page-'+id).classList.toggle('hidden', id !== p);
                document.getElementById('nav-'+id).classList.toggle('active', id === p);
            });
            if(p==='review') renderReview();
        }

        function speak(t) {
            if(!t) return;
            window.speechSynthesis.cancel();
            const m = new SpeechSynthesisUtterance(t);
            m.lang = currentLang === 'kr' ? 'ko-KR' : 'ja-JP';
            window.speechSynthesis.speak(m);
        }

        function assemble(letters) {
            let res = ""; let i = 0; let temp = [...letters];
            for (let k = 0; k < temp.length - 1; k++) {
                let combo = temp[k] + temp[k+1];
                if (COMPLEX_VOWELS[combo]) { temp.splice(k, 2, COMPLEX_VOWELS[combo]); k--; }
            }
            while (i < temp.length) {
                let c = CHO.indexOf(temp[i]);
                if (c === -1) { res += temp[i]; i++; continue; }
                let j = (i + 1 < temp.length) ? JUNG.indexOf(temp[i+1]) : -1;
                if (j === -1) { res += temp[i]; i++; continue; }
                let z = 0, hasJong = false;
                if (i + 2 < temp.length) {
                    let zIndex = JONG.indexOf(temp[i+2]);
                    if (zIndex > 0) {
                        let nextIsV = (i + 3 < temp.length) && (JUNG.indexOf(temp[i+3]) !== -1);
                        if (!nextIsV) { z = zIndex; hasJong = true; }
                    }
                }
                res += String.fromCharCode(0xAC00 + (c * 588) + (j * 28) + z);
                i += (hasJong ? 3 : 2);
            }
            return res;
        }

        function startQuiz() {
            if(filteredWords.length === 0) return alert("è«‹å…ˆåŒæ­¥è³‡æ–™ï¼");
            document.getElementById('quizArea').classList.remove('hidden');
            userTyped = ""; document.getElementById('mainDisplay').innerText = "???";
            document.getElementById('feedback').innerText = "";
            currentWord = filteredWords[Math.floor(Math.random() * filteredWords.length)];
            targetText = currentLang === 'kr' ? currentWord.kr : (currentWord.kana || currentWord.jp);
            const pad = document.getElementById('choicesPad'); pad.innerHTML = "";
            let parts = targetText.split('');
            let pool = currentLang === 'kr' ? "ì´ê°€ë‚˜ë‹¤ë¼ë§ˆë°”ì‚¬" : "ã‚ã„ã†ãˆãŠã‹ãã";
            let choices = [...new Set([...parts, ...pool.split('').sort(()=>Math.random()-0.5).slice(0, 6)])];
            choices.sort(()=>Math.random()-0.5).forEach(c => {
                const b = document.createElement('button'); b.className = "choice-btn"; b.innerText = c;
                b.onclick = () => { speak(c); userTyped += c; document.getElementById('mainDisplay').innerText = userTyped; };
                pad.appendChild(b);
            });
            speak(targetText);
        }

        function checkAnswer() {
            const f = document.getElementById('feedback');
            if(userTyped === targetText) { f.innerText = "âœ… æ­£ç¢ºï¼"; f.style.color = "green"; setTimeout(startQuiz, 1200); }
            else { f.innerText = "âŒ ç­”æ¡ˆ: " + targetText; f.style.color = "red"; }
        }

        function startSpellQuiz() {
            if(filteredWords.length === 0) return alert("è«‹å…ˆåŒæ­¥ï¼");
            document.getElementById('spellArea').classList.remove('hidden');
            spellBuffer = []; updateSpellUI();
            document.getElementById('spellFeedback').innerText = "";
            currentWord = filteredWords[Math.floor(Math.random() * filteredWords.length)];
            const cp = document.getElementById('con-keys'), vp = document.getElementById('vow-keys');
            cp.innerHTML = ""; vp.innerHTML = "";
            CHO.forEach(k => { if(k){ const b = document.createElement('button'); b.className="k-btn"; b.innerText=k; b.onclick=()=>{ speak(k); spellBuffer.push(k); updateSpellUI(); }; cp.appendChild(b); }});
            JUNG.forEach(k => { if(k){ const b = document.createElement('button'); b.className="k-btn"; b.innerText=k; b.onclick=()=>{ speak(k); spellBuffer.push(k); updateSpellUI(); }; vp.appendChild(b); }});
            speak(currentWord.kr);
        }
        function updateSpellUI() { document.getElementById('spellDisplay').innerText = assemble(spellBuffer); }
        function checkSpell() {
            if(assemble(spellBuffer) === currentWord.kr) { document.getElementById('spellFeedback').innerText = "âœ… æ­£ç¢ºï¼"; document.getElementById('spellFeedback').style.color="green"; setTimeout(startSpellQuiz, 1200); }
            else { document.getElementById('spellFeedback').innerText = "âŒ ç­”æ¡ˆ: " + currentWord.kr; document.getElementById('spellFeedback').style.color="red"; }
        }

        function renderReview() {
            const list = document.getElementById('wordList');
            if(filteredWords.length === 0) { list.innerHTML = "<p style='color:#999; padding:20px;'>æ­¤åˆ†é¡ç„¡è³‡æ–™</p>"; return; }
            list.innerHTML = filteredWords.map(w => {
                let main = currentLang==='kr' ? w.kr : (w.kana || w.jp);
                let sub = w.cn + (w.cat ? ` [${w.cat}]` : "");
                return `<div class="word-item"><div><b>${main}</b><br><small>${sub}</small></div><button onclick="speak('${main}')" style="background:none;color:var(--primary);font-size:1.5rem;padding:0;border:none;cursor:pointer;">ğŸ”Š</button></div>`;
            }).join('');
        }
        
        function toggleAutoplay() { isAutoplay = !isAutoplay; if (isAutoplay) { document.getElementById('autoBtn').innerText="â¹ï¸ åœæ­¢"; playNextAuto(); } else stopAutoplay(); }
        function stopAutoplay() { isAutoplay = false; clearTimeout(autoTimer); document.getElementById('autoBtn').innerText="â–¶ï¸ æ’­æ”¾"; }
        function playNextAuto() { 
            if (!isAutoplay || filteredWords.length === 0) return; 
            const w = filteredWords[autoIndex]; 
            const txt = currentLang==='kr'?w.kr:(w.kana||w.jp); 
            document.getElementById('auto-kr').innerText = txt; 
            document.getElementById('auto-cn').innerText = w.cn; 
            speak(txt); 
            autoIndex = (autoIndex + 1) % filteredWords.length; 
            autoTimer = setTimeout(playNextAuto, 3000); 
        }
    </script>
</body>
</html>