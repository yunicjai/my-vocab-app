<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>éŸ“æ—¥é›™èªå­¸ç¿’ - å¼·åŒ–ç·´ç¿’ç‰ˆ</title>
    <style>
        :root { --primary: #5c67f2; --bg: #f0f2f5; --jp-color: #ff7675; --kr-color: #5c67f2; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; padding-bottom: 90px; text-align: center; color: #333; }
        .lang-switcher { background: #2d3436; padding: 12px; display: flex; flex-direction: column; align-items: center; gap: 10px; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .lang-btn-row { display: flex; gap: 10px; }
        .lang-btn { background: #636e72; color: white; border: none; padding: 8px 18px; border-radius: 20px; cursor: pointer; font-size: 0.85rem; font-weight: bold; transition: 0.2s; }
        .lang-btn.active.kr { background: var(--kr-color); transform: scale(1.05); }
        .lang-btn.active.jp { background: var(--jp-color); transform: scale(1.05); }
        #cat-selector { background: #fff; color: #333; border-radius: 10px; padding: 6px 12px; border: none; font-size: 0.85rem; width: 85%; max-width: 320px; outline: none; }
        .container { padding: 15px; max-width: 500px; margin: 0 auto; }
        .card { background: white; padding: 20px; border-radius: 18px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); margin-bottom: 20px; }
        .display-box { font-size: 2.2rem; min-height: 70px; margin: 15px 0; border: 3px solid #eee; border-radius: 15px; padding: 10px; color: var(--primary); display: flex; flex-direction: column; justify-content: center; align-items: center; background: #fafafa; }
        .choice-btn { background: #f9f9ff; color: var(--primary); border: 2px solid #eef0ff; font-size: 1.3rem; min-width: 80px; padding: 12px; border-radius: 12px; font-weight: bold; cursor: pointer; margin: 4px; transition: 0.2s; }
        .nav { background: white; padding: 10px 0; display: flex; justify-content: space-around; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); position: fixed; bottom: 0; width: 100%; z-index: 999; }
        .nav-btn { cursor: pointer; color: #b2bec3; font-size: 0.8rem; display: flex; flex-direction: column; align-items: center; text-decoration: none; font-weight: bold; }
        .nav-btn.active { color: var(--primary); }
        .nav-icon { font-size: 1.4rem; margin-bottom: 2px; }
        .hidden { display: none !important; }
        .kana-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
        .hint-box { margin-top: 10px; padding: 10px; background: #fff5f5; border: 1px dashed #feb2b2; border-radius: 10px; color: #c53030; }
        button { background: var(--primary); color: white; border: none; padding: 12px 20px; border-radius: 12px; cursor: pointer; font-weight: bold; }
        
        /* å¾ªç’°æ’­æ”¾ç¾åŒ–æ¨£å¼ */
        .auto-card { background: linear-gradient(135deg, #ffffff 0%, #f9f9ff 100%); border: 2px solid var(--primary); padding: 40px 20px; position: relative; overflow: hidden; }
        .auto-count { position: absolute; top: 15px; right: 20px; font-size: 0.8rem; color: #999; background: #eee; padding: 4px 10px; border-radius: 20px; }
        .auto-badge { background: var(--primary); color: white; padding: 2px 10px; border-radius: 4px; font-size: 0.7rem; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div class="lang-switcher">
        <div class="lang-btn-row">
            <button class="lang-btn active kr" id="lang-kr" onclick="changeLang('kr')">ğŸ‡°ğŸ‡· éŸ“æ–‡</button>
            <button class="lang-btn jp" id="lang-jp" onclick="changeLang('jp')">ğŸ‡¯ğŸ‡µ æ—¥æ–‡</button>
        </div>
        <select id="cat-selector" onchange="filterByCategory()">
            <option value="all">ğŸ“ å…¨éƒ¨å–®å­—</option>
        </select>
    </div>

    <div class="container">
        <div class="card" style="padding: 10px;">
            <button onclick="fetchData()" style="width: 100%; background: #636e72;">ğŸ”„ åŒæ­¥è³‡æ–™èˆ‡åˆ†é¡</button>
            <div id="status" style="font-size: 0.75rem; margin-top: 5px; color: #888;">è«‹å…ˆé»æ“ŠåŒæ­¥</div>
        </div>

        <div id="page-review" class="hidden"><div class="card"><div id="wordList"></div></div></div>

        <div id="page-auto" class="hidden">
            <div class="card auto-card">
                <div id="auto-repeat-tag" class="auto-count">é‡è¤‡ 1 / 3</div>
                <div id="auto-cat-badge" class="auto-badge">åˆ†é¡</div>
                <div id="auto-kr" style="font-size:3.5rem; font-weight:bold; color:var(--primary); margin: 10px 0;">-</div>
                <div id="auto-cn" style="font-size:1.4rem; color:#666; margin-top:10px; border-top: 1px solid #eee; padding-top:15px;">-</div>
            </div>
            <div style="display:flex; gap:10px;">
                <button id="autoBtn" onclick="toggleAutoplay()" style="flex:2; background:#20bf6b; font-size:1.2rem; height:60px; box-shadow: 0 4px 0 #1b9e58;">â–¶ï¸ é–‹å§‹å¾ªç’°è½åŠ›</button>
                <button onclick="playNextAuto(true)" style="flex:1; background:#636e72;">è·³é â­ï¸</button>
            </div>
            <p style="font-size:0.8rem; color:#999; margin-top:15px;">æ¯å€‹å–®å­—å°‡é‡è¤‡æ’­æ”¾ 3 æ¬¡å¾Œè‡ªå‹•åˆ‡æ›</p>
        </div>

        <div id="page-quiz">
            <div class="card">
                <h3>ğŸ§ ç¶œåˆå¼·åŒ–æ¸¬é©—</h3>
                <button onclick="startQuiz()" style="width:100%; background:#20bf6b;">ğŸ® é–‹å§‹æŒ‘æˆ°</button>
                <div id="quizArea" class="hidden">
                    <button onclick="speak(targetText)" style="background:#636e72; font-size:0.85rem;">ğŸ”Š é‡è½é¡Œç›®</button>
                    <div id="mainDisplay" class="display-box">???</div>
                    <div id="spellPad"></div>
                    <div id="meaningPad" class="hidden"></div>
                    <div id="spellControls" style="margin-top:20px; display:flex; gap:10px;">
                        <button onclick="userTyped=''; document.getElementById('mainDisplay').innerText='???'; document.getElementById('hint-area').classList.add('hidden');" style="flex:1; background:#fab1a0">æ¸…é™¤</button>
                        <button onclick="checkStepOne()" style="flex:2;">ä¸‹ä¸€æ­¥</button>
                    </div>
                    <div id="hint-area" class="hint-box hidden">ğŸ’¡ æ­£ç¢ºç­”æ¡ˆæ˜¯ï¼š<b id="correct-text"></b></div>
                    <p id="feedback" style="font-weight:bold; margin-top:10px;"></p>
                </div>
            </div>
        </div>

        <div id="page-spell" class="hidden"><div class="card"><h3>ğŸ§© è½éŸ³çµ„å­—æŒ‘æˆ°</h3><button onclick="startSpellQuiz()" style="width:100%; background:#a29bfe;">ğŸ® é–‹å§‹çµ„å­—</button></div></div>
        <div id="page-kana" class="hidden">
            <div class="card">
                <h3>ğŸ’® äº”åéŸ³æŒ‘æˆ°</h3>
                <div style="display:flex; gap:10px; margin-bottom:15px;"><button id="hira-mode" onclick="setKanaMode('hira')" style="flex:1; background:var(--jp-color)">å¹³å‡å</button><button id="kata-mode" onclick="setKanaMode('kata')" style="flex:1; font-size:0.8rem; background:#636e72">ç‰‡å‡å</button></div>
                <button onclick="startKanaQuiz()" style="width:100%; background:#ff7675;">ğŸ® éš¨æ©Ÿæ¸¬é©—</button>
                <div id="kanaArea" class="hidden"><div id="kanaTarget" class="display-box">?</div><div id="kanaChoices" class="kana-grid"></div><button onclick="speak(correctKana.k)" style="background:#636e72; margin-top:15px; font-size:0.85rem; width:100%;">ğŸ”Š é‡è½è²éŸ³</button></div>
            </div>
        </div>
    </div>

    <div class="nav">
        <div class="nav-btn" id="nav-review" onclick="showPage('review')"><span class="nav-icon">ğŸ“–</span>æ¸…å–®</div>
        <div class="nav-btn" id="nav-auto" onclick="showPage('auto')"><span class="nav-icon">ğŸ”„</span>å¾ªç’°</div>
        <div class="nav-btn active" id="nav-quiz" onclick="showPage('quiz')"><span class="nav-icon">ğŸ§</span>æ¸¬é©—</div>
        <div class="nav-btn" id="nav-spell" onclick="showPage('spell')"><span class="nav-icon">ğŸ§©</span>æ‹¼å­—</div>
        <div class="nav-btn hidden" id="nav-kana" onclick="showPage('kana')"><span class="nav-icon">ğŸ’®</span>äº”åéŸ³</div>
    </div>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbx-8obNpgBEWiodpefAYnKFxGptbXaTRxre9oQcxTvr6Gjfg2VgMAUYp8g2nv8_gdO_Uw/exec"; 
        let allWords = [], filteredWords = [], currentWord = {}, userTyped = "", targetText = "", targetMeaning = "", currentLang = 'kr', isAutoplay = false, autoIndex = 0, autoTimer, repeatCount = 0;

        const kanaData = [
            {k:'ã‚', kt:'ã‚¢', r:'a'}, {k:'ã„', kt:'ã‚¤', r:'i'}, {k:'ã†', kt:'ã‚¦', r:'u'}, {k:'ãˆ', kt:'ã‚¨', r:'e'}, {k:'ãŠ', kt:'ã‚ª', r:'o'},
            {k:'ã‹', kt:'ã‚«', r:'ka'}, {k:'ã', kt:'ã‚­', r:'ki'}, {k:'ã', kt:'ã‚¯', r:'ku'}, {k:'ã‘', kt:'ã‚±', r:'ke'}, {k:'ã“', kt:'ã‚³', r:'ko'},
            {k:'ã•', kt:'ã‚µ', r:'sa'}, {k:'ã—', kt:'ã‚·', r:'shi'}, {k:'ã™', kt:'ã‚¹', r:'su'}, {k:'ã›', kt:'ã‚»', r:'se'}, {k:'ã', kt:'è˜‡', r:'so'},
            {k:'ãŸ', kt:'å¤•', r:'ta'}, {k:'ã¡', kt:'åƒ', r:'chi'}, {k:'ã¤', kt:'ãƒ„', r:'tsu'}, {k:'ã¦', kt:'ãƒ†', r:'te'}, {k:'ã¨', kt:'åœ', r:'to'},
            {k:'ãª', kt:'ãƒŠ', r:'na'}, {k:'ã«', kt:'äºŒ', r:'ni'}, {k:'ã¬', kt:'ãƒŒ', r:'nu'}, {k:'ã­', kt:'ãƒ', r:'ne'}, {k:'ã®', kt:'ãƒ', r:'no'},
            {k:'ã¯', kt:'ãƒ', r:'ha'}, {k:'ã²', kt:'ãƒ’', r:'hi'}, {k:'ãµ', kt:'ãƒ•', r:'fu'}, {k:'ã¸', kt:'ãƒ˜', r:'he'}, {k:'ã»', kt:'ãƒ›', r:'ho'},
            {k:'ã¾', kt:'ãƒ', r:'ma'}, {k:'ã¿', kt:'ãƒŸ', r:'mi'}, {k:'ã‚€', kt:'ãƒ ', r:'mu'}, {k:'ã‚', kt:'ãƒ¡', r:'me'}, {k:'ã‚‚', kt:'ãƒ¢', r:'mo'},
            {k:'ã‚„', kt:'ãƒ¤', r:'ya'}, {k:'ã‚†', kt:'ãƒ¦', r:'yu'}, {k:'ã‚ˆ', kt:'ãƒ¨', r:'yo'},
            {k:'ã‚‰', kt:'ãƒ©', r:'ra'}, {k:'ã‚Š', kt:'ãƒª', r:'ri'}, {k:'ã‚‹', kt:'ãƒ«', r:'ru'}, {k:'ã‚Œ', kt:'ãƒ¬', r:'re'}, {k:'ã‚', kt:'ãƒ­', r:'ro'},
            {k:'ã‚', kt:'ãƒ¯', r:'wa'}, {k:'ã‚’', kt:'ãƒ²', r:'wo'}, {k:'ã‚“', kt:'ãƒ³', r:'n'}
        ];

        async function fetchData() {
            document.getElementById('status').innerText = "â³ åŒæ­¥ä¸­...";
            try {
                const res = await fetch(`${GAS_URL}?lang=${currentLang}&t=${Date.now()}`);
                allWords = await res.json();
                updateCategoryMenu(); filterByCategory();
                document.getElementById('status').innerText = `âœ… å·²åŒæ­¥ ${allWords.length} å€‹å–®å­—`;
            } catch (e) { document.getElementById('status').innerText = "âŒ åŒæ­¥å¤±æ•—"; }
        }

        function changeLang(l) { 
            currentLang = l; 
            document.getElementById('lang-kr').classList.toggle('active', l==='kr');
            document.getElementById('lang-jp').classList.toggle('active', l==='jp');
            document.getElementById('nav-spell').classList.toggle('hidden', l==='jp');
            document.getElementById('nav-kana').classList.toggle('hidden', l==='kr');
            document.documentElement.style.setProperty('--primary', l==='kr' ? '#5c67f2' : '#ff7675');
            fetchData(); showPage('quiz');
        }

        function showPage(p) {
            stopAutoplay();
            ['quiz', 'review', 'auto', 'spell', 'kana'].forEach(id => {
                const el = document.getElementById('page-'+id);
                if(el) el.classList.toggle('hidden', id !== p);
                const navBtn = document.getElementById('nav-'+id);
                if(navBtn) navBtn.classList.toggle('active', id === p);
            });
            if(p==='review') renderReview();
            if(p==='kana') startKanaQuiz();
        }

        function speak(t) {
            if(!t) return;
            window.speechSynthesis.cancel();
            const m = new SpeechSynthesisUtterance(t);
            m.rate = 0.75;
            m.lang = currentLang === 'kr' ? 'ko-KR' : 'ja-JP';
            window.speechSynthesis.speak(m);
        }

        // --- å¼·åŒ–å¾Œçš„å¾ªç’°æ’­æ”¾é‚è¼¯ ---
        function toggleAutoplay() { 
            isAutoplay = !isAutoplay; 
            if (isAutoplay) { 
                document.getElementById('autoBtn').innerText="â¹ï¸ åœæ­¢"; 
                document.getElementById('autoBtn').style.background = "#ff7675";
                repeatCount = 0; 
                playNextAuto(); 
            } else {
                stopAutoplay();
            }
        }

        function stopAutoplay() { 
            isAutoplay = false; 
            clearTimeout(autoTimer); 
            document.getElementById('autoBtn').innerText="â–¶ï¸ é–‹å§‹å¾ªç’°è½åŠ›"; 
            document.getElementById('autoBtn').style.background = "#20bf6b";
        }

        function playNextAuto(forceNext = false) { 
            if (!isAutoplay || filteredWords.length === 0) return; 

            if (forceNext) { repeatCount = 0; autoIndex = (autoIndex + 1) % filteredWords.length; }

            const w = filteredWords[autoIndex]; 
            const txt = currentLang==='kr'?w.kr:(w.kana||w.jp); 
            
            // æ›´æ–°ä»‹é¢
            document.getElementById('auto-kr').innerText = txt; 
            document.getElementById('auto-cn').innerText = w.cn; 
            document.getElementById('auto-cat-badge').innerText = w.cat || "å…¨éƒ¨";
            
            repeatCount++;
            document.getElementById('auto-repeat-tag').innerText = `é‡è¤‡ ${repeatCount} / 3`;
            
            speak(txt); 
            
            if (repeatCount >= 3) {
                repeatCount = 0;
                autoIndex = (autoIndex + 1) % filteredWords.length;
                autoTimer = setTimeout(playNextAuto, 3500); // ä¸‹ä¸€é¡Œé–“éš”ç¨é•·
            } else {
                autoTimer = setTimeout(playNextAuto, 2000); // åŒé¡Œé‡è¤‡é–“éš”è¼ƒçŸ­
            }
        }

        // å…¶é¤˜æ¸¬é©—èˆ‡äº”åéŸ³é‚è¼¯ç¶­æŒ... (ç•¥ï¼Œä¿æŒåŸæœ‰åŠŸèƒ½)
        function startQuiz() { if(filteredWords.length === 0) return alert("è«‹å…ˆåŒæ­¥è³‡æ–™ï¼"); document.getElementById('quizArea').classList.remove('hidden'); document.getElementById('spellPad').classList.remove('hidden'); document.getElementById('meaningPad').classList.add('hidden'); document.getElementById('spellControls').classList.remove('hidden'); document.getElementById('hint-area').classList.add('hidden'); userTyped = ""; document.getElementById('mainDisplay').innerText = "???"; document.getElementById('feedback').innerText = ""; currentWord = filteredWords[Math.floor(Math.random() * filteredWords.length)]; targetText = currentLang === 'kr' ? currentWord.kr : (currentWord.kana || currentWord.jp); targetMeaning = currentWord.cn; const sPad = document.getElementById('spellPad'); sPad.innerHTML = ""; let parts = targetText.split(''); let pool = currentLang === 'kr' ? "ì´ê°€ë‚˜ë‹¤ë¼ë§ˆë°”ì‚¬" : "ã‚ã„ã†ãˆãŠã‹ãã"; let choices = [...new Set([...parts, ...pool.split('').sort(()=>Math.random()-0.5).slice(0, 6)])]; choices.sort(()=>Math.random()-0.5).forEach(c => { const b = document.createElement('button'); b.className = "choice-btn"; b.innerText = c; b.onclick = () => { speak(c); userTyped += c; document.getElementById('mainDisplay').innerText = userTyped; }; sPad.appendChild(b); }); speak(targetText); }
        function checkStepOne() { if(userTyped === targetText) { document.getElementById('spellPad').classList.add('hidden'); document.getElementById('spellControls').classList.add('hidden'); document.getElementById('hint-area').classList.add('hidden'); showMeaningOptions(); } else { document.getElementById('correct-text').innerText = targetText; document.getElementById('hint-area').classList.remove('hidden'); document.getElementById('feedback').innerText = "âŒ æ‹¼å¯«éŒ¯èª¤"; document.getElementById('feedback').style.color = "red"; speak(targetText); } }
        function showMeaningOptions() { const mPad = document.getElementById('meaningPad'); mPad.classList.remove('hidden'); mPad.innerHTML = ""; let choices = [targetMeaning]; while(choices.length < 4 && filteredWords.length >= 4) { let r = filteredWords[Math.floor(Math.random() * filteredWords.length)].cn; if(!choices.includes(r)) choices.push(r); } choices.sort(()=>Math.random()-0.5).forEach(c => { const b = document.createElement('button'); b.className = "choice-btn"; b.innerText = c; b.style.width = "80%"; b.onclick = () => { if(c === targetMeaning) { document.getElementById('mainDisplay').innerHTML = `${targetText}<br><small style="color:#666">${targetMeaning}</small>`; document.getElementById('feedback').innerText = "âœ… æ­£ç¢ºï¼"; document.getElementById('feedback').style.color = "green"; setTimeout(startQuiz, 1500); } else { document.getElementById('feedback').innerText = "âŒ æ„æ€é¸éŒ¯äº†"; document.getElementById('feedback').style.color = "red"; } }; mPad.appendChild(b); }); }
        let correctKana = null; function setKanaMode(mode) { kanaMode = mode; document.getElementById('hira-mode').style.background = (mode==='hira' ? 'var(--jp-color)' : '#636e72'); document.getElementById('kata-mode').style.background = (mode==='kata' ? 'var(--jp-color)' : '#636e72'); startKanaQuiz(); }
        function startKanaQuiz() { document.getElementById('kanaArea').classList.remove('hidden'); correctKana = kanaData[Math.floor(Math.random() * kanaData.length)]; document.getElementById('kanaTarget').innerText = "?"; document.getElementById('kanaTarget').style.color = "var(--primary)"; speak(correctKana.k); let options = [correctKana]; while(options.length < 6) { let r = kanaData[Math.floor(Math.random() * kanaData.length)]; if(!options.find(o => o.k === r.k)) options.push(r); } options.sort(() => Math.random() - 0.5); const box = document.getElementById('kanaChoices'); box.innerHTML = ''; options.forEach(opt => { const b = document.createElement('button'); b.className = "choice-btn"; const displayChar = (kanaMode === 'hira' ? opt.k : opt.kt); b.innerText = displayChar; b.onclick = () => { if(opt.k === correctKana.k) { document.getElementById('kanaTarget').innerText = displayChar; document.getElementById('kanaTarget').style.color = "#20bf6b"; b.style.background = "#20bf6b"; b.style.color = "#fff"; const btns = box.querySelectorAll('button'); btns.forEach(btn => btn.disabled = true); setTimeout(startKanaQuiz, 1200); } else { b.style.background = "#ff7675"; b.style.color = "#fff"; speak(correctKana.k); } }; box.appendChild(b); }); }
        function updateCategoryMenu() { const menu = document.getElementById('cat-selector'); const cats = [...new Set(allWords.map(w => w.cat).filter(c => c))]; menu.innerHTML = '<option value="all">ğŸ“ å…¨éƒ¨å–®å­—</option>' + cats.map(c => `<option value="${c}">${c}</option>`).join(''); }
        function filterByCategory() { const selected = document.getElementById('cat-selector').value; filteredWords = (selected === 'all') ? allWords : allWords.filter(w => String(w.cat) === selected); if(!document.getElementById('page-review').classList.contains('hidden')) renderReview(); }
        function renderReview() { const list = document.getElementById('wordList'); if(filteredWords.length === 0) { list.innerHTML = "<p>ç„¡è³‡æ–™</p>"; return; } list.innerHTML = filteredWords.map(w => { let main = currentLang==='kr' ? w.kr : (w.kana || w.jp); return `<div class="word-item"><div><b>${main}</b><br><small>${w.cn}</small></div><button onclick="speak('${main}')" style="background:none;color:var(--primary);font-size:1.2rem;border:none;">ğŸ”Š</button></div>`; }).join(''); }
    </script>
</body>
</html>
