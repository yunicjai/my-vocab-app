<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>éŸ“æ—¥é›™èªå­¸ç¿’ - å¼·åŒ–ç·´ç¿’ç‰ˆ</title>
    <style>
        :root { --primary: #5c67f2; --bg: #f0f2f5; --jp-color: #ff7675; --kr-color: #5c67f2; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; padding-bottom: 90px; text-align: center; color: #333; }
        .lang-switcher { background: #2d3436; padding: 12px; display: flex; flex-direction: column; align-items: center; gap: 10px; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .lang-btn-row { display: flex; gap: 10px; }
        .lang-btn { background: #636e72; color: white; border: none; padding: 8px 18px; border-radius: 20px; cursor: pointer; font-size: 0.85rem; font-weight: bold; transition: 0.2s; }
        .lang-btn.active.kr { background: var(--kr-color); transform: scale(1.05); box-shadow: 0 0 10px rgba(92,103,242,0.4); }
        .lang-btn.active.jp { background: var(--jp-color); transform: scale(1.05); box-shadow: 0 0 10px rgba(255,118,117,0.4); }
        #cat-selector { background: #fff; color: #333; border-radius: 10px; padding: 6px 12px; border: none; font-size: 0.85rem; width: 85%; max-width: 320px; outline: none; font-weight: bold; }
        .container { padding: 15px; max-width: 500px; margin: 0 auto; }
        .card { background: white; padding: 20px; border-radius: 18px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); margin-bottom: 20px; }
        .display-box { font-size: 2.2rem; min-height: 70px; margin: 15px 0; border: 3px solid #eee; border-radius: 15px; padding: 10px; color: var(--primary); display: flex; flex-direction: column; justify-content: center; align-items: center; background: #fafafa; transition: all 0.3s; letter-spacing: 2px; }
        
        .choice-btn, .k-btn { background: #f9f9ff; color: #2d3436 !important; border: 1px solid #eef0ff; border-bottom: 3px solid #b2bec3; font-size: 1.1rem; padding: 12px; border-radius: 12px; font-weight: bold; cursor: pointer; margin: 3px; min-width: 45px; transition: 0.1s; }
        .choice-btn:active, .k-btn:active { transform: translateY(2px); border-bottom: 1px solid #b2bec3; background: var(--primary); color: white !important; }

        .nav { background: white; padding: 10px 0; display: flex; justify-content: space-around; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); position: fixed; bottom: 0; width: 100%; z-index: 999; }
        .nav-btn { cursor: pointer; color: #b2bec3; font-size: 0.8rem; display: flex; flex-direction: column; align-items: center; text-decoration: none; font-weight: bold; transition: 0.2s; }
        .nav-btn.active { color: var(--primary); }
        .nav-icon { font-size: 1.4rem; margin-bottom: 2px; }
        button { background: var(--primary); color: white; border: none; padding: 12px 20px; border-radius: 12px; cursor: pointer; font-weight: bold; font-size: 1rem; }
        .hidden { display: none !important; }
        .word-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #eee; text-align: left; }
        .step-hint { font-size: 0.85rem; color: #e67e22; font-weight: bold; margin-bottom: 5px; }
        .hint-box { margin-top: 10px; padding: 10px; background: #fff5f5; border: 1px dashed #feb2b2; border-radius: 10px; color: #c53030; font-size: 0.9rem; }
        .key-row { display: flex; justify-content: center; flex-wrap: wrap; gap: 2px; margin-top: 5px; }
    </style>
</head>
<body>

    <div class="lang-switcher">
        <div class="lang-btn-row">
            <button class="lang-btn active kr" id="lang-kr" onclick="changeLang('kr')">ğŸ‡°ğŸ‡· éŸ“æ–‡</button>
            <button class="lang-btn jp" id="lang-jp" onclick="changeLang('jp')">ğŸ‡¯ğŸ‡µ æ—¥æ–‡</button>
        </div>
        <select id="cat-selector" onchange="filterByCategory()">
            <option value="all">ğŸ“ å…¨éƒ¨å–®å­—</option>
        </select>
    </div>

    <div class="container">
        <div class="card" style="padding: 10px;">
            <button onclick="fetchData()" style="width: 100%; background: #636e72;">ğŸ”„ åŒæ­¥è³‡æ–™èˆ‡åˆ†é¡</button>
            <div id="status" style="font-size: 0.75rem; margin-top: 5px; color: #888;">è«‹å…ˆé»æ“ŠåŒæ­¥</div>
        </div>

        <div id="page-review" class="hidden"><div class="card"><div id="wordList"></div></div></div>

        <div id="page-auto" class="hidden">
            <div class="card">
                <div id="auto-repeat-info" style="font-size: 0.75rem; color: #999; text-align: right; margin-bottom: 5px;">é‡è¤‡ 1 / 3</div>
                <div id="auto-kr" style="font-size:2.8rem; font-weight:bold; color:var(--primary); line-height:1.2;"></div>
                <div id="auto-cn" style="font-size:1.2rem; color:#666; margin-top:15px;"></div>
            </div>
            <button id="autoBtn" onclick="toggleAutoplay()" style="width:100%; background:#ff7675;">â–¶ï¸ æ’­æ”¾</button>
        </div>

        <div id="page-quiz">
            <div class="card">
                <h3>ğŸ§ ç¶œåˆå¼·åŒ–æ¸¬é©—</h3>
                <button id="startQuizBtn" onclick="startQuiz()" style="width:100%; background:#20bf6b; box-shadow: 0 4px 0 #1b9e58;">ğŸ® é–‹å§‹æŒ‘æˆ°</button>
                <div id="quizArea" class="hidden">
                    <div id="step-msg" class="step-hint">ç¬¬ä¸€æ­¥ï¼šæ‹¼å‡ºæ­£ç¢ºå–®å­—</div>
                    <button onclick="speak(targetText)" style="background:#636e72; font-size:0.85rem;">ğŸ”Š é‡è½é¡Œç›®</button>
                    <div id="mainDisplay" class="display-box">???</div>
                    <div id="spellPad" class="key-row"></div>
                    <div id="meaningPad" class="key-row hidden"></div>
                    <div id="spellControls" style="margin-top:20px; display:flex; gap:10px;">
                        <button onclick="userTyped=''; document.getElementById('mainDisplay').innerText='???'; document.getElementById('hint-area').classList.add('hidden');" style="flex:1; background:#fab1a0">æ¸…é™¤</button>
                        <button onclick="checkStepOne()" style="flex:2;">ä¸‹ä¸€æ­¥</button>
                    </div>
                    <div id="hint-area" class="hint-box hidden">
                        ğŸ’¡ æ­£ç¢ºç­”æ¡ˆæ˜¯ï¼š<b id="correct-text"></b> 
                        <button onclick="speak(targetText)" style="padding: 2px 8px; font-size: 0.7rem; background: #c53030;">ğŸ”Š</button>
                    </div>
                    <p id="feedback" style="font-weight:bold; margin-top:10px;"></p>
                </div>
            </div>
        </div>

        <div id="page-spell" class="hidden">
            <div class="card">
                <h3>ğŸ§© æ‹¼å­—æŒ‘æˆ°</h3>
                <button onclick="startSpellQuiz()" style="width:100%; background:#a29bfe;">ğŸ® è½éŸ³çµ„å­—</button>
                <div id="spellArea" class="hidden">
                    <button onclick="speak(currentWord.kr)" style="background:#636e72; margin-top:10px; font-size:0.85rem;">ğŸ”Š é‡è½å–®å­—</button>
                    <div id="spellDisplay" class="display-box"></div>
                    <div id="con-keys" class="key-row"></div>
                    <div id="vow-keys" class="key-row" style="margin-top:10px; border-top:1px dashed #ccc; padding-top:10px;"></div>
                    <div style="margin-top:20px; display:flex; gap:10px;">
                        <button onclick="spellBuffer=[]; updateSpellUI();" style="flex:1; background:#fab1a0">æ¸…é™¤</button>
                        <button onclick="checkSpell()" style="flex:2;">æª¢æŸ¥æ‹¼å­—</button>
                    </div>
                    <p id="spellFeedback" style="font-weight:bold; margin-top:10px;"></p>
                </div>
            </div>
        </div>

        <div id="page-kana" class="hidden">
            <div class="card">
                <h3>ğŸ’® äº”åéŸ³æŒ‘æˆ°</h3>
                <div style="display:flex; gap:10px; margin-bottom:15px;"><button id="hira-mode" onclick="setKanaMode('hira')" style="flex:1; font-size:0.8rem; background:var(--jp-color)">å¹³å‡å</button><button id="kata-mode" onclick="setKanaMode('kata')" style="flex:1; font-size:0.8rem; background:#636e72">ç‰‡å‡å</button></div>
                <button onclick="startKanaQuiz()" style="width:100%; background:#ff7675;">ğŸ® éš¨æ©Ÿæ¸¬é©—</button>
                <div id="kanaArea" class="hidden">
                    <div id="kanaTarget" class="display-box">?</div>
                    <div class="kana-grid" id="kanaChoices" style="display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-top:10px;"></div>
                    <button onclick="speak(correctKana.k)" style="width:100%; margin-top:15px; background:#636e72; color:white; border:none; padding:12px; border-radius:10px;">ğŸ”Š é‡è½é¡Œç›®</button>
                </div>
            </div>
        </div>
    </div>

    <div class="nav">
        <div class="nav-btn" id="nav-review" onclick="showPage('review')"><span class="nav-icon">ğŸ“–</span>æ¸…å–®</div>
        <div class="nav-btn" id="nav-auto" onclick="showPage('auto')"><span class="nav-icon">ğŸ”„</span>å¾ªç’°</div>
        <div class="nav-btn active" id="nav-quiz" onclick="showPage('quiz')"><span class="nav-icon">ğŸ§</span>æ¸¬é©—</div>
        <div id="nav-dynamic-btn" class="nav-btn" onclick="handleDynamicNav()"><span class="nav-icon" id="dynamic-icon">ğŸ§©</span><span id="dynamic-text">æ‹¼å­—</span></div>
    </div>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbx-8obNpgBEWiodpefAYnKFxGptbXaTRxre9oQcxTvr6Gjfg2VgMAUYp8g2nv8_gdO_Uw/exec"; 
        let allWords = [], filteredWords = [], currentWord = {}, userTyped = "", targetText = "", targetMeaning = "", currentLang = 'kr', isAutoplay = false, autoIndex = 0, autoTimer, spellBuffer = [], repeatCount = 0;

        const CHO = ["ã„±","ã„²","ã„´","ã„·","ã„¸","ã„¹","ã…","ã…‚","ã…ƒ","ã……","ã…†","ã…‡","ã…ˆ","ã…‰","ã…Š","ã…‹","ã…Œ","ã…","ã…"];
        const JUNG = ["ã…","ã…","ã…‘","ã…’","ã…“","ã…”","ã…•","ã…–","ã…—","ã…˜","ã…™","ã…š","ã…›","ã…œ","ã…","ã…","ã…Ÿ","ã… ","ã…¡","ã…¢","ã…£"];
        const JONG = ["","ã„±","ã„²","ã„³","ã„´","ã„µ","ã„¶","ã„·","ã„¹","ã„º","ã„»","ã„¼","ã„½","ã„¾","ã„¿","ã…€","ã…","ã…‚","ã…„","ã……","ã…†","ã…‡","ã…ˆ","ã…Š","ã…‹","ã…Œ","ã…","ã…"];
        const COMPLEX_VOWELS = { "ã…—ã…": "ã…˜", "ã…—ã…": "ã…™", "ã…—ã…£": "ã…š", "ã…œã…“": "ã…", "ã…œã…”": "ã…", "ã…œã…£": "ã…Ÿ", "ã…¡ã…£": "ã…¢" };

        const kanaData = [
            {k:'ã‚', kt:'ã‚¢'}, {k:'ã„', kt:'ã‚¤'}, {k:'ã†', kt:'ã‚¦'}, {k:'ãˆ', kt:'ã‚¨'}, {k:'ãŠ', kt:'ã‚ª'},
            {k:'ã‹', kt:'ã‚«'}, {k:'ã', kt:'ã‚­'}, {k:'ã', kt:'ã‚¯'}, {k:'ã‘', kt:'ã‚±'}, {k:'ã“', kt:'ã‚³'},
            {k:'ã•', kt:'ã‚µ'}, {k:'ã—', kt:'ã‚·'}, {k:'ã™', kt:'ã‚¹'}, {k:'ã›', kt:'ã‚»'}, {k:'ã', kt:'ã‚½'},
            {k:'ãŸ', kt:'ã‚¿'}, {k:'ã¡', kt:'ãƒ'}, {k:'ã¤', kt:'ãƒ„'}, {k:'ã¦', kt:'ãƒ†'}, {k:'ã¨', kt:'ãƒˆ'},
            {k:'ãª', kt:'ãƒŠ'}, {k:'ã«', kt:'ãƒ‹'}, {k:'ã¬', kt:'ãƒŒ'}, {k:'ã­', kt:'ãƒ'}, {k:'ã®', kt:'ãƒ'},
            {k:'ã¯', kt:'ãƒ'}, {k:'ã²', kt:'ãƒ’'}, {k:'ãµ', kt:'ãƒ•'}, {k:'ã¸', kt:'ãƒ˜'}, {k:'ã»', kt:'ãƒ›'},
            {k:'ã¾', kt:'ãƒ'}, {k:'ã¿', kt:'ãƒŸ'}, {k:'ã‚€', kt:'ãƒ '}, {k:'ã‚', kt:'ãƒ¡'}, {k:'ã‚‚', kt:'ãƒ¢'},
            {k:'ã‚„', kt:'ãƒ¤'}, {k:'ã‚†', kt:'ãƒ¦'}, {k:'ã‚ˆ', kt:'ãƒ¨'},
            {k:'ã‚‰', kt:'ãƒ©'}, {k:'ã‚Š', kt:'ãƒª'}, {k:'ã‚‹', kt:'ãƒ«'}, {k:'ã‚Œ', kt:'ãƒ¬'}, {k:'ã‚', kt:'ãƒ­'},
            {k:'ã‚', kt:'ãƒ¯'}, {k:'ã‚’', kt:'ãƒ²'}, {k:'ã‚“', kt:'ãƒ³'}
        ];

        async function fetchData() {
            document.getElementById('status').innerText = "â³ åŒæ­¥ä¸­...";
            try {
                const res = await fetch(`${GAS_URL}?lang=${currentLang}&t=${Date.now()}`);
                allWords = await res.json();
                updateCategoryMenu(); filterByCategory();
                document.getElementById('status').innerText = `âœ… å·²åŒæ­¥ ${allWords.length} å€‹å–®å­—`;
            } catch (e) { document.getElementById('status').innerText = "âŒ åŒæ­¥å¤±æ•—"; }
        }

        function changeLang(l) { 
            currentLang = l; 
            document.getElementById('lang-kr').classList.toggle('active', l==='kr');
            document.getElementById('lang-jp').classList.toggle('active', l==='jp');
            document.getElementById('dynamic-icon').innerText = l==='kr' ? 'ğŸ§©' : 'ğŸ’®';
            document.getElementById('dynamic-text').innerText = l==='kr' ? 'æ‹¼å­—' : 'äº”åéŸ³';
            document.documentElement.style.setProperty('--primary', l==='kr' ? '#5c67f2' : '#ff7675');
            fetchData(); showPage('quiz');
        }

        function handleDynamicNav() { showPage(currentLang === 'kr' ? 'spell' : 'kana'); }

        function showPage(p) {
            stopAutoplay();
            ['quiz', 'review', 'auto', 'spell', 'kana'].forEach(id => {
                const el = document.getElementById('page-'+id);
                if(el) el.classList.toggle('hidden', id !== p);
            });
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            const activeId = (p === 'spell' || p === 'kana') ? 'nav-dynamic-btn' : 'nav-' + p;
            if(document.getElementById(activeId)) document.getElementById(activeId).classList.add('active');
            if(p==='review') renderReview();
            if(p==='spell') initSpellKeyboard();
            if(p==='kana') startKanaQuiz();
        }

        function speak(t) {
            if(!t) return;
            window.speechSynthesis.cancel();
            const m = new SpeechSynthesisUtterance(t);
            m.rate = 0.75;
            m.lang = currentLang === 'kr' ? 'ko-KR' : 'ja-JP';
            window.speechSynthesis.speak(m);
        }

        function assemble(letters) {
            let res = ""; let i = 0; let temp = [...letters];
            for (let k = 0; k < temp.length - 1; k++) {
                let combo = temp[k] + temp[k+1];
                if (COMPLEX_VOWELS[combo]) { temp.splice(k, 2, COMPLEX_VOWELS[combo]); k--; }
            }
            while (i < temp.length) {
                let c = CHO.indexOf(temp[i]);
                if (c === -1) { res += temp[i]; i++; continue; }
                let j = (i + 1 < temp.length) ? JUNG.indexOf(temp[i+1]) : -1;
                if (j === -1) { res += temp[i]; i++; continue; }
                let z = 0;
                if (i + 2 < temp.length) {
                    let zIndex = JONG.indexOf(temp[i+2]);
                    if (zIndex > 0) {
                        let nextIsV = (i + 3 < temp.length) && (JUNG.indexOf(temp[i+3]) !== -1);
                        if (!nextIsV) { z = zIndex; i += 3; } else { i += 2; }
                    } else { i += 2; }
                } else { i += 2; }
                res += String.fromCharCode(0xAC00 + (c * 588) + (j * 28) + z);
            }
            return res;
        }

        function updateSpellUI() { document.getElementById('spellDisplay').innerText = assemble(spellBuffer); }

        function initSpellKeyboard() {
            const cp = document.getElementById('con-keys'); cp.innerHTML = "";
            const vp = document.getElementById('vow-keys'); vp.innerHTML = "";
            CHO.forEach(k => {
                let b = document.createElement('button'); b.className="k-btn"; b.innerText=k;
                b.onclick=()=>{ speak(k); spellBuffer.push(k); updateSpellUI(); }; cp.appendChild(b);
            });
            JUNG.forEach(k => {
                let b = document.createElement('button'); b.className="k-btn"; b.innerText=k;
                b.onclick=()=>{ speak(k); spellBuffer.push(k); updateSpellUI(); }; vp.appendChild(b);
            });
        }

        function startSpellQuiz() {
            if(filteredWords.length === 0) return alert("åŒæ­¥è³‡æ–™å¾Œé–‹å§‹");
            document.getElementById('spellArea').classList.remove('hidden');
            spellBuffer = []; updateSpellUI(); document.getElementById('spellFeedback').innerText = "";
            currentWord = filteredWords[Math.floor(Math.random() * filteredWords.length)];
            speak(currentWord.kr);
        }

        function checkSpell() {
            if(assemble(spellBuffer) === currentWord.kr) {
                document.getElementById('spellFeedback').innerText = "âœ… æ­£ç¢ºï¼";
                setTimeout(startSpellQuiz, 1200);
            } else {
                document.getElementById('spellFeedback').innerText = "âŒ éŒ¯èª¤ï¼Œç­”æ¡ˆæ˜¯: " + currentWord.kr;
            }
        }

        function startQuiz() {
            if(filteredWords.length === 0) return alert("åŒæ­¥è³‡æ–™å¾Œé–‹å§‹");
            document.getElementById('quizArea').classList.remove('hidden');
            document.getElementById('spellPad').classList.remove('hidden');
            document.getElementById('meaningPad').classList.add('hidden');
            document.getElementById('spellControls').classList.remove('hidden');
            document.getElementById('hint-area').classList.add('hidden');
            userTyped = ""; document.getElementById('mainDisplay').innerText = "???"; document.getElementById('feedback').innerText = "";
            currentWord = filteredWords[Math.floor(Math.random() * filteredWords.length)];
            
            targetText = currentLang === 'kr' ? currentWord.kr : (currentWord.kana || currentWord.jp);
            targetMeaning = currentWord.cn;

            const sPad = document.getElementById('spellPad'); sPad.innerHTML = "";
            let parts = targetText.split('');
            // ä¿®æ”¹ï¼šä¿®æ­£éŸ“æ–‡ Poolï¼Œç§»é™¤ä¸­æ–‡å­—
            let pool = currentLang === 'kr' ? "ì´ê°€ë‚˜ë‹¤ë¼ë§ˆë°”ì‚¬" : "ã‚ã„ã†ãˆãŠã‹ããã‘ã“";
            let choices = [...new Set([...parts, ...pool.split('').sort(()=>Math.random()-0.5).slice(0, 5)])];
            choices.sort(()=>Math.random()-0.5).forEach(c => {
                const b = document.createElement('button'); b.className = "choice-btn"; b.innerText = c;
                b.onclick = () => { speak(c); userTyped += c; document.getElementById('mainDisplay').innerText = userTyped; };
                sPad.appendChild(b);
            });
            speak(targetText);
        }

        function checkStepOne() {
            if(userTyped === targetText) {
                document.getElementById('spellPad').classList.add('hidden');
                document.getElementById('spellControls').classList.add('hidden');
                showMeaningOptions();
            } else {
                document.getElementById('correct-text').innerText = targetText;
                document.getElementById('hint-area').classList.remove('hidden');
                speak(targetText);
            }
        }

        function showMeaningOptions() {
            const mPad = document.getElementById('meaningPad'); mPad.classList.remove('hidden'); mPad.innerHTML = "";
            let choices = [targetMeaning];
            while(choices.length < 4 && filteredWords.length >= 4) {
                let r = filteredWords[Math.floor(Math.random() * filteredWords.length)].cn;
                if(!choices.includes(r)) choices.push(r);
            }
            choices.sort(()=>Math.random()-0.5).forEach(c => {
                const b = document.createElement('button'); b.className = "choice-btn"; b.innerText = c;
                b.style.width = "85%"; b.onclick = () => {
                    if(c === targetMeaning) {
                        let displayTxt = currentLang === 'kr' ? targetText : `${currentWord.jp}<br><span style="font-size:1.2rem; font-weight:normal;">(${currentWord.kana})</span>`;
                        document.getElementById('mainDisplay').innerHTML = `${displayTxt}<br><small style="color:#666">${targetMeaning}</small>`;
                        setTimeout(startQuiz, 2500);
                    }
                };
                mPad.appendChild(b);
            });
        }

        let correctKana = null; let kanaMode = 'hira';
        function setKanaMode(m) { kanaMode = m; startKanaQuiz(); }
        function startKanaQuiz() {
            document.getElementById('kanaArea').classList.remove('hidden');
            correctKana = kanaData[Math.floor(Math.random() * kanaData.length)];
            document.getElementById('kanaTarget').innerText = "?";
            speak(correctKana.k);
            let options = [correctKana];
            while(options.length < 6) {
                let r = kanaData[Math.floor(Math.random() * kanaData.length)];
                if(!options.find(o => o.k === r.k)) options.push(r);
            }
            options.sort(() => Math.random() - 0.5);
            const box = document.getElementById('kanaChoices'); box.innerHTML = '';
            options.forEach(opt => {
                const b = document.createElement('button'); b.className = "choice-btn";
                b.innerText = kanaMode === 'hira' ? opt.k : opt.kt;
                b.onclick = () => {
                    if(opt.k === correctKana.k) {
                        document.getElementById('kanaTarget').innerText = b.innerText;
                        setTimeout(startKanaQuiz, 1200);
                    } else speak(correctKana.k);
                };
                box.appendChild(b);
            });
        }

        function updateCategoryMenu() { const menu = document.getElementById('cat-selector'); const cats = [...new Set(allWords.map(w => w.cat).filter(c => c))]; menu.innerHTML = '<option value="all">ğŸ“ å…¨éƒ¨å–®å­—</option>' + cats.map(c => `<option value="${c}">${c}</option>`).join(''); }
        function filterByCategory() { const selected = document.getElementById('cat-selector').value; filteredWords = (selected === 'all') ? allWords : allWords.filter(w => String(w.cat) === selected); if(!document.getElementById('page-review').classList.contains('hidden')) renderReview(); }
        
        function renderReview() { 
            const list = document.getElementById('wordList'); 
            list.innerHTML = filteredWords.map(w => {
                let mainText = currentLang === 'kr' ? w.kr : `${w.jp} (${w.kana})`;
                return `<div class="word-item"><div><b>${mainText}</b><br>${w.cn}</div><button onclick="speak('${currentLang==='kr'?w.kr:w.kana}')">ğŸ”Š</button></div>`;
            }).join(''); 
        }
        
        // ä¿®æ”¹ï¼šå¾ªç’°æ’­æ”¾é‡è½ 3 æ¬¡é‚è¼¯
        function toggleAutoplay() { 
            isAutoplay = !isAutoplay; 
            if(isAutoplay) {
                repeatCount = 0; // é‡ç½®é‡è¤‡è¨ˆæ•¸
                document.getElementById('autoBtn').innerText = "â¹ï¸ åœæ­¢";
                playNextAuto(); 
            } else {
                stopAutoplay();
            }
        }
        function stopAutoplay() { 
            isAutoplay = false; 
            clearTimeout(autoTimer); 
            document.getElementById('autoBtn').innerText = "â–¶ï¸ æ’­æ”¾";
        }
        
        function playNextAuto() { 
            if(!isAutoplay || filteredWords.length === 0) return; 
            
            let w = filteredWords[autoIndex]; 
            let mainTxt = currentLang === 'kr' ? w.kr : `${w.jp}<br><span style="font-size:1.2rem; font-weight:normal;">(${w.kana})</span>`;
            document.getElementById('auto-kr').innerHTML = mainTxt; 
            document.getElementById('auto-cn').innerText = w.cn; 
            
            repeatCount++;
            document.getElementById('auto-repeat-info').innerText = `é‡è¤‡ ${repeatCount} / 3`;
            speak(currentLang === 'kr' ? w.kr : w.kana); 

            if(repeatCount < 3) {
                // åŒä¸€å€‹å­—é‚„æ²’æ’­å®Œ 3 æ¬¡
                autoTimer = setTimeout(playNextAuto, 2000); // æ¯æ¬¡é‡è¤‡é–“éš” 2 ç§’
            } else {
                // æ’­å®Œ 3 æ¬¡ï¼Œæº–å‚™æ›ä¸‹ä¸€å€‹
                repeatCount = 0;
                autoIndex = (autoIndex + 1) % filteredWords.length; 
                autoTimer = setTimeout(playNextAuto, 3500); // æ›å­—é–“éš”ç¨é•·
            }
        }
    </script>
</body>
</html>
