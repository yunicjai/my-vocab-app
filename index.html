<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>éŸ“æ—¥é›™èªå­¸ç¿’ - ç©©å®šæ•´åˆç‰ˆ</title>
    <style>
        :root { --primary: #5c67f2; --bg: #f0f2f5; --jp-color: #ff7675; --kr-color: #5c67f2; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; padding-bottom: 90px; text-align: center; color: #333; }
        .lang-switcher { background: #2d3436; padding: 12px; display: flex; flex-direction: column; align-items: center; gap: 8px; position: sticky; top: 0; z-index: 1000; }
        .lang-btn { background: #636e72; color: white; border: none; padding: 8px 18px; border-radius: 20px; cursor: pointer; font-weight: bold; font-size: 0.85rem; }
        .lang-btn.active.kr { background: var(--kr-color); box-shadow: 0 0 10px rgba(92,103,242,0.5); }
        .lang-btn.active.jp { background: var(--jp-color); box-shadow: 0 0 10px rgba(255,118,117,0.5); }
        #cat-selector { background: white; border-radius: 10px; padding: 6px; width: 85%; max-width: 320px; border: none; font-weight: bold; }
        .container { padding: 15px; max-width: 500px; margin: 0 auto; }
        .card { background: white; padding: 20px; border-radius: 18px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); margin-bottom: 20px; }
        .display-box { font-size: 2.2rem; min-height: 85px; margin: 15px 0; border: 3px solid #eee; border-radius: 15px; padding: 10px; color: #2d3436 !important; background: #fafafa; display: flex; flex-direction: column; justify-content: center; align-items: center; font-weight: bold; }
        .choice-btn, .k-btn { background: #f9f9ff; color: #2d3436 !important; border: 1px solid #dcdde1; border-bottom: 3px solid #b2bec3; font-size: 1.1rem; padding: 12px; border-radius: 12px; font-weight: bold; cursor: pointer; margin: 3px; min-width: 48px; transition: 0.1s; }
        .choice-btn:active, .k-btn:active { transform: translateY(2px); border-bottom: 1px solid #b2bec3; background: var(--primary); color: white !important; }
        .nav { background: white; padding: 10px 0; display: flex; justify-content: space-around; position: fixed; bottom: 0; width: 100%; z-index: 999; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
        .nav-btn { cursor: pointer; color: #b2bec3; font-size: 0.7rem; font-weight: bold; display: flex; flex-direction: column; align-items: center; }
        .nav-btn.active { color: var(--primary); }
        .hidden { display: none !important; }
        .key-row { display: flex; justify-content: center; flex-wrap: wrap; gap: 2px; margin-top: 5px; }
        .hint-box { margin-top: 10px; padding: 10px; background: #fff5f5; border: 1px dashed #feb2b2; border-radius: 10px; color: #c53030; font-size: 0.9rem; }
    </style>
</head>
<body>

    <div class="lang-switcher">
        <div style="display:flex; gap:10px;">
            <button class="lang-btn active kr" id="lang-kr" onclick="changeLang('kr')">ğŸ‡°ğŸ‡· éŸ“æ–‡</button>
            <button class="lang-btn jp" id="lang-jp" onclick="changeLang('jp')">ğŸ‡¯ğŸ‡µ æ—¥æ–‡</button>
        </div>
        <select id="cat-selector" onchange="filterByCategory()">
            <option value="all">ğŸ“ å…¨éƒ¨å–®å­—</option>
        </select>
    </div>

    <div class="container">
        <div class="card" style="padding: 10px;">
            <button onclick="fetchData()" style="width: 100%; background: #636e72; color:white; padding:12px; border-radius:8px; border:none; font-weight:bold;">ğŸ”„ åŒæ­¥å–®å­—è³‡æ–™</button>
            <div id="status" style="font-size: 0.7rem; margin-top: 5px; color: #888;">å°±ç·’</div>
        </div>

        <div id="page-review" class="hidden"><div class="card"><div id="wordList"></div></div></div>

        <div id="page-auto" class="hidden">
            <div class="card" style="border: 2px solid var(--primary);">
                <div id="auto-repeat-info" style="font-size: 0.75rem; color: #999; text-align: right;">é‡è¤‡ 1 / 3</div>
                <div id="auto-main" style="font-size:3.2rem; font-weight:bold; color:var(--primary);">-</div>
                <div id="auto-sub" style="font-size:1.2rem; color:#666;"></div>
                <div id="auto-cn" style="font-size:1.4rem; color:#333; margin-top:15px; border-top:1px solid #eee; padding-top:10px;">-</div>
            </div>
            <button id="autoBtn" onclick="toggleAutoplay()" style="width:100%; background:#ff7675; color:white; height:55px; border-radius:12px; border:none; font-weight:bold;">â–¶ï¸ é–‹å§‹å¾ªç’°</button>
        </div>

        <div id="page-quiz">
            <div class="card">
                <h3>ğŸ§ è½éŸ³ç¶œåˆæ¸¬é©—</h3>
                <button onclick="startQuiz()" style="width:100%; background:#20bf6b; color:white; border-radius:12px; padding:12px; border:none;">ğŸ® é–‹å§‹æŒ‘æˆ°</button>
                <div id="quizArea" class="hidden">
                    <button onclick="speak(quizTarget)" style="background:#636e72; color:white; font-size:0.8rem; padding:6px 15px; border-radius:15px; border:none;">ğŸ”Š é‡è½é¡Œç›®</button>
                    <div id="quizDisplay" class="display-box">???</div>
                    <div id="quizSpellPad" class="key-row"></div>
                    <div id="quizMeaningPad" class="key-row hidden"></div>
                    <div id="quizControls" style="margin-top:20px; display:flex; gap:10px;">
                        <button onclick="quizInput=''; document.getElementById('quizDisplay').innerText='???';" style="flex:1; background:#fab1a0; border-radius:10px; border:none; padding:10px;">æ¸…é™¤</button>
                        <button onclick="checkQuizStepOne()" style="flex:2; background:var(--primary); color:white; border-radius:10px; border:none;">æª¢æŸ¥æ‹¼å¯«</button>
                    </div>
                    <div id="quiz-hint" class="hint-box hidden">ğŸ’¡ æ­£ç¢ºæ˜¯ï¼š<b id="quiz-correct-text"></b></div>
                    <p id="quizFeedback" style="font-weight:bold; margin-top:10px;"></p>
                </div>
            </div>
        </div>

        <div id="page-cn-spell" class="hidden">
            <div class="card">
                <h3>âœï¸ ä¸­æ–‡çœ‹ç¾©æ‹¼å­—</h3>
                <button onclick="startCnSpellQuiz()" style="width:100%; background:#f39c12; color:white; border-radius:12px; padding:12px; border:none;">ğŸ® é–‹å§‹æŒ‘æˆ°</button>
                <div id="cnSpellArea" class="hidden">
                    <div id="cnSpellTarget" style="font-size:1.8rem; font-weight:bold; color:#2c3e50; margin-bottom:15px;"></div>
                    <div id="cnSpellDisplay" class="display-box"></div>
                    <div id="cnSpellPad" class="key-row"></div>
                    <div style="margin-top:20px; display:flex; gap:10px;">
                        <button onclick="cnInput=''; document.getElementById('cnSpellDisplay').innerText='';" style="flex:1; background:#fab1a0; border-radius:10px; border:none; padding:10px;">æ¸…é™¤</button>
                        <button onclick="checkCnSpellAnswer()" style="flex:2; background:#f39c12; color:white; border-radius:10px; border:none;">æª¢æŸ¥ç­”æ¡ˆ</button>
                    </div>
                    <p id="cnSpellFeedback" style="font-weight:bold; margin-top:10px;"></p>
                </div>
            </div>
        </div>

        <div id="page-spell" class="hidden">
            <div class="card">
                <h3>ğŸ§© åŸºç¤æ‹¼å­—æŒ‘æˆ°</h3>
                <button onclick="startBasicSpellQuiz()" style="width:100%; background:#a29bfe; color:white; border-radius:12px; padding:12px; border:none;">ğŸ® é–‹å§‹æŒ‘æˆ°</button>
                <div id="basicSpellArea" class="hidden">
                    <button onclick="speak(basicSpellCurrent)" style="background:#636e72; color:white; font-size:0.85rem; padding:8px 20px; border-radius:20px; border:none; margin-bottom:10px;">ğŸ”Š é‡è½é¡Œç›®</button>
                    <div id="basicSpellDisplay" class="display-box"></div>
                    <div id="con-keys" class="key-row"></div>
                    <div id="vow-keys" class="key-row" style="margin-top:10px; border-top:1px dashed #ccc; padding-top:10px;"></div>
                    <div style="margin-top:20px; display:flex; gap:10px;">
                        <button onclick="basicSpellBuffer=[]; updateBasicSpellUI();" style="flex:1; background:#fab1a0; border-radius:10px; border:none; padding:10px;">æ¸…é™¤</button>
                        <button onclick="checkBasicSpellAnswer()" style="flex:2; background:#a29bfe; color:white; border-radius:10px; border:none;">æª¢æŸ¥ç­”æ¡ˆ</button>
                    </div>
                    <p id="basicSpellFeedback" style="font-weight:bold; margin-top:10px;"></p>
                </div>
            </div>
        </div>

        <div id="page-kana" class="hidden">
            <div class="card">
                <h3>ğŸ’® äº”åéŸ³æŒ‘æˆ°</h3>
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <button id="hira-mode" onclick="setKanaMode('hira')" style="flex:1; background:var(--jp-color); color:white; padding:10px; border-radius:8px; border:none;">å¹³å‡å</button>
                    <button id="kata-mode" onclick="setKanaMode('kata')" style="flex:1; background:#636e72; color:white; padding:10px; border-radius:8px; border:none;">ç‰‡å‡å</button>
                </div>
                <div id="kanaArea" class="hidden">
                    <div id="kanaTarget" class="display-box">ğŸ”Š ?</div>
                    <div id="kanaChoices" style="display:grid; grid-template-columns:repeat(3, 1fr); gap:10px; margin-top:10px;"></div>
                    <button onclick="speak(correctKana.k)" style="width:100%; margin-top:15px; background:#636e72; color:white; border-radius:10px; border:none; padding:12px;">ğŸ”Š é‡è½è²éŸ³</button>
                </div>
            </div>
        </div>
    </div>

    <div class="nav">
        <div class="nav-btn" id="nav-review" onclick="showPage('review')">ğŸ“–æ¸…å–®</div>
        <div class="nav-btn" id="nav-auto" onclick="showPage('auto')">ğŸ”„å¾ªç’°</div>
        <div class="nav-btn active" id="nav-quiz" onclick="showPage('quiz')">ğŸ§æ¸¬é©—</div>
        <div class="nav-btn" id="nav-cn-spell" onclick="showPage('cn-spell')">âœï¸çœ‹ç¾©</div>
        <div class="nav-btn" id="nav-spell" onclick="showPage('spell')">ğŸ§©æ‹¼å­—</div>
        <div class="nav-btn hidden" id="nav-kana" onclick="showPage('kana')">ğŸ’®éŸ³</div>
    </div>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbx-8obNpgBEWiodpefAYnKFxGptbXaTRxre9oQcxTvr6Gjfg2VgMAUYp8g2nv8_gdO_Uw/exec"; 
        let allWords = [], filteredWords = [], currentLang = 'kr', isAutoplay = false, autoIndex = 0, autoTimer, repeatCount = 0;
        let quizInput = "", quizTarget = "", cnInput = "", cnTarget = "", basicSpellBuffer = [], basicSpellCurrent = "", kanaMode = 'hira', correctKana = null;

        const CHO = ["ã„±","ã„²","ã„´","ã„·","ã„¸","ã„¹","ã…","ã…‚","ã…ƒ","ã……","ã…†","ã…‡","ã…ˆ","ã…‰","ã…Š","ã…‹","ã…Œ","ã…","ã…"];
        const JUNG = ["ã…","ã…","ã…‘","ã…’","ã…“","ã…”","ã…•","ã…–","ã…—","ã…˜","ã…™","ã…š","ã…›","ã…œ","ã…","ã…","ã…Ÿ","ã… ","ã…¡","ã…¢","ã…£"];
        const JONG = ["","ã„±","ã„²","ã„³","ã„´","ã„µ","ã„¶","ã„·","ã„¹","ã„º","ã„»","ã„¼","ã„½","ã„¾","ã„¿","ã…€","ã…","ã…‚","ã…„","ã……","ã…†","ã…‡","ã…ˆ","ã…Š","ã…‹","ã…Œ","ã…","ã…"];

        const kanaData = [
            {k:'ã‚', kt:'ã‚¢'}, {k:'ã„', kt:'ã‚¤'}, {k:'ã†', kt:'ã‚¦'}, {k:'ãˆ', kt:'ã‚¨'}, {k:'ãŠ', kt:'ã‚ª'},
            {k:'ã‹', kt:'ã‚«'}, {k:'ã', kt:'ã‚­'}, {k:'ã', kt:'ã‚¯'}, {k:'ã‘', kt:'ã‚±'}, {k:'ã“', kt:'ã‚³'},
            {k:'ã•', kt:'ã‚µ'}, {k:'ã—', kt:'ã‚·'}, {k:'ã™', kt:'ã‚¹'}, {k:'ã›', kt:'ã‚»'}, {k:'ã', kt:'ã‚½'},
            {k:'ãŸ', kt:'ã‚¿'}, {k:'ã¡', kt:'ãƒ'}, {k:'ã¤', kt:'ãƒ„'}, {k:'ã¦', kt:'ãƒ†'}, {k:'ã¨', kt:'ãƒˆ'},
            {k:'ãª', kt:'ãƒŠ'}, {k:'ã«', kt:'ãƒ‹'}, {k:'ã¬', kt:'ãƒŒ'}, {k:'ã­', kt:'ãƒ'}, {k:'ã®', kt:'ãƒ'},
            {k:'ã¯', kt:'ãƒ'}, {k:'ã²', kt:'ãƒ’'}, {k:'ãµ', kt:'ãƒ•'}, {k:'ã¸', kt:'ãƒ˜'}, {k:'ã»', kt:'ãƒ›'},
            {k:'ã¾', kt:'ãƒ'}, {k:'ã¿', kt:'ãƒŸ'}, {k:'ã‚€', kt:'ãƒ '}, {k:'ã‚', kt:'ãƒ¡'}, {k:'ã‚‚', kt:'ãƒ¢'},
            {k:'ã‚„', kt:'ãƒ¤'}, {k:'ã‚†', kt:'ãƒ¦'}, {k:'ã‚ˆ', kt:'ãƒ¨'},
            {k:'ã‚‰', kt:'ãƒ©'}, {k:'ã‚Š', kt:'ãƒª'}, {k:'ã‚‹', kt:'ãƒ«'}, {k:'ã‚Œ', kt:'ãƒ¬'}, {k:'ã‚', kt:'ãƒ­'},
            {k:'ã‚', kt:'ãƒ¯'}, {k:'ã‚’', kt:'ãƒ²'}, {k:'ã‚“', kt:'ãƒ³'}
        ];

        async function fetchData() {
            document.getElementById('status').innerText = "â³ åŒæ­¥ä¸­...";
            try {
                const res = await fetch(`${GAS_URL}?lang=${currentLang}&t=${Date.now()}`);
                allWords = await res.json();
                updateCategoryMenu(); filterByCategory();
                document.getElementById('status').innerText = `âœ… å·²åŒæ­¥ ${allWords.length} å€‹å–®å­—`;
            } catch (e) { document.getElementById('status').innerText = "âŒ åŒæ­¥å¤±æ•—"; }
        }

        function changeLang(l) { 
            currentLang = l; 
            document.getElementById('lang-kr').classList.toggle('active', l==='kr');
            document.getElementById('lang-jp').classList.toggle('active', l==='jp');
            document.getElementById('nav-spell').classList.toggle('hidden', l==='jp');
            document.getElementById('nav-kana').classList.toggle('hidden', l==='kr');
            document.documentElement.style.setProperty('--primary', l==='kr' ? '#5c67f2' : '#ff7675');
            fetchData(); showPage('quiz');
        }

        function showPage(p) {
            stopAutoplay();
            ['quiz', 'review', 'auto', 'spell', 'kana', 'cn-spell'].forEach(id => {
                const el = document.getElementById('page-'+id);
                if(el) el.classList.toggle('hidden', id !== p);
                const btn = document.getElementById('nav-'+id);
                if(btn) btn.classList.toggle('active', id === p);
            });
            if(p==='review') renderReview();
            if(p==='spell') initBasicSpellKeyboard();
            if(p==='kana') startKanaQuiz();
        }

        function speak(t) {
            if(!t) return;
            window.speechSynthesis.cancel();
            const m = new SpeechSynthesisUtterance(t);
            m.rate = 0.8; m.lang = currentLang === 'kr' ? 'ko-KR' : 'ja-JP';
            window.speechSynthesis.speak(m);
        }

        // --- éŸ“æ–‡çµ„å­—é‚è¼¯ ---
        function assemble(letters) {
            let res = ""; let i = 0; let temp = [...letters];
            while (i < temp.length) {
                let c = CHO.indexOf(temp[i]);
                if (c === -1) { res += temp[i]; i++; continue; }
                let j = (i + 1 < temp.length) ? JUNG.indexOf(temp[i+1]) : -1;
                if (j === -1) { res += temp[i]; i++; continue; }
                let z = 0;
                if (i + 2 < temp.length) {
                    let zIndex = JONG.indexOf(temp[i+2]);
                    if (zIndex > 0) {
                        let nextIsV = (i + 3 < temp.length) && (JUNG.indexOf(temp[i+3]) !== -1);
                        if (!nextIsV) { z = zIndex; i += 3; } else { i += 2; }
                    } else { i += 2; }
                } else { i += 2; }
                res += String.fromCharCode(0xAC00 + (c * 588) + (j * 28) + z);
            }
            return res;
        }

        // --- äº”åéŸ³æŒ‘æˆ° (ğŸ’®) ---
        function setKanaMode(m) { kanaMode = m; startKanaQuiz(); }
        function startKanaQuiz() {
            document.getElementById('kanaArea').classList.remove('hidden');
            correctKana = kanaData[Math.floor(Math.random() * kanaData.length)];
            document.getElementById('kanaTarget').innerText = "ğŸ”Š ?";
            speak(correctKana.k);
            let options = [correctKana];
            while(options.length < 6) {
                let r = kanaData[Math.floor(Math.random() * kanaData.length)];
                if(!options.find(o => o.k === r.k)) options.push(r);
            }
            options.sort(() => Math.random() - 0.5);
            const box = document.getElementById('kanaChoices'); box.innerHTML = '';
            options.forEach(opt => {
                const b = document.createElement('button'); b.className = "choice-btn";
                const displayChar = (kanaMode === 'hira' ? opt.k : opt.kt);
                b.innerText = displayChar;
                b.onclick = () => {
                    if(opt.k === correctKana.k) {
                        document.getElementById('kanaTarget').innerText = displayChar;
                        setTimeout(startKanaQuiz, 1200);
                    } else {
                        speak(correctKana.k);
                    }
                };
                box.appendChild(b);
            });
        }

        // --- åŸºç¤æ‹¼å­—ç·´ç¿’ (ğŸ§©) ---
        function initBasicSpellKeyboard() {
            const cp = document.getElementById('con-keys'); const vp = document.getElementById('vow-keys');
            cp.innerHTML = ""; vp.innerHTML = "";
            CHO.forEach(k => {
                let b = document.createElement('button'); b.className="k-btn"; b.innerText=k;
                b.onclick=()=>{ speak(k); basicSpellBuffer.push(k); updateBasicSpellUI(); }; cp.appendChild(b);
            });
            JUNG.forEach(k => {
                let b = document.createElement('button'); b.className="k-btn"; b.innerText=k;
                b.onclick=()=>{ speak(k); basicSpellBuffer.push(k); updateBasicSpellUI(); }; vp.appendChild(b);
            });
        }
        function updateBasicSpellUI() { document.getElementById('basicSpellDisplay').innerText = assemble(basicSpellBuffer); }
        function startBasicSpellQuiz() {
            if(filteredWords.length === 0) return alert("åŒæ­¥è³‡æ–™å¾Œé–‹å§‹");
            document.getElementById('basicSpellArea').classList.remove('hidden');
            basicSpellBuffer = []; updateBasicSpellUI(); document.getElementById('basicSpellFeedback').innerText = "";
            const wordObj = filteredWords[Math.floor(Math.random() * filteredWords.length)];
            basicSpellCurrent = wordObj.kr;
            speak(basicSpellCurrent);
        }
        function checkBasicSpellAnswer() {
            if(assemble(basicSpellBuffer) === basicSpellCurrent) {
                document.getElementById('basicSpellFeedback').innerText = "âœ… æ­£ç¢ºï¼";
                setTimeout(startBasicSpellQuiz, 1500);
            } else {
                document.getElementById('basicSpellFeedback').innerText = "âŒ æ‡‰ç‚º: " + basicSpellCurrent;
            }
        }

        // --- å…¶ä»–æ¸¬é©—æ¨¡çµ„ (å·²ç©©å®š) ---
        function startQuiz() {
            if(filteredWords.length === 0) return;
            document.getElementById('quizArea').classList.remove('hidden');
            document.getElementById('quizSpellPad').classList.remove('hidden');
            document.getElementById('quizMeaningPad').classList.add('hidden');
            document.getElementById('quiz-hint').classList.add('hidden');
            quizInput = ""; document.getElementById('quizDisplay').innerText = "???"; document.getElementById('quizFeedback').innerText = "";
            const wordObj = filteredWords[Math.floor(Math.random() * filteredWords.length)];
            currentWord = wordObj;
            quizTarget = currentLang === 'kr' ? wordObj.kr : wordObj.kana;
            const sPad = document.getElementById('quizSpellPad'); sPad.innerHTML = "";
            let pool = currentLang === 'kr' ? "ì´ê°€ë‚˜ë‹¤ë¼ë§ˆ" : "ã‚ã„ã†ãˆãŠã‹";
            let choices = [...new Set([...quizTarget.split(''), ...pool.split('').sort(()=>Math.random()-0.5).slice(0, 5)])];
            choices.sort(()=>Math.random()-0.5).forEach(c => {
                const b = document.createElement('button'); b.className = "choice-btn"; b.innerText = c;
                b.onclick = () => { speak(c); quizInput += c; document.getElementById('quizDisplay').innerText = quizInput; };
                sPad.appendChild(b);
            });
            speak(quizTarget);
        }
        function checkQuizStepOne() {
            if(quizInput === quizTarget) {
                document.getElementById('quizSpellPad').classList.add('hidden');
                document.getElementById('quizMeaningPad').classList.remove('hidden');
                showQuizMeaningChoices();
            } else {
                document.getElementById('quiz-correct-text').innerText = quizTarget;
                document.getElementById('quiz-hint').classList.remove('hidden');
                speak(quizTarget);
            }
        }
        function showQuizMeaningChoices() {
            const mPad = document.getElementById('quizMeaningPad'); mPad.innerHTML = "";
            let choices = [currentWord.cn];
            while(choices.length < 4 && filteredWords.length >= 4) {
                let r = filteredWords[Math.floor(Math.random() * filteredWords.length)].cn;
                if(!choices.includes(r)) choices.push(r);
            }
            choices.sort(()=>Math.random()-0.5).forEach(c => {
                const b = document.createElement('button'); b.className = "choice-btn"; b.innerText = c;
                b.onclick = () => {
                    if(c === currentWord.cn) {
                        let txt = currentLang==='kr' ? currentWord.kr : `${currentWord.jp}<br>(${currentWord.kana})`;
                        document.getElementById('quizDisplay').innerHTML = txt + `<br><small>${currentWord.cn}</small>`;
                        setTimeout(startQuiz, 2000);
                    }
                };
                mPad.appendChild(b);
            });
        }

        function startCnSpellQuiz() {
            if(filteredWords.length === 0) return;
            document.getElementById('cnSpellArea').classList.remove('hidden');
            cnInput = ""; document.getElementById('cnSpellDisplay').innerText = "";
            const wordObj = filteredWords[Math.floor(Math.random() * filteredWords.length)];
            currentWord = wordObj;
            document.getElementById('cnSpellTarget').innerText = wordObj.cn;
            cnTarget = currentLang === 'kr' ? wordObj.kr : wordObj.kana;
            const sPad = document.getElementById('cnSpellPad'); sPad.innerHTML = "";
            let pool = currentLang === 'kr' ? "ì´ê°€ë‚˜ë‹¤ë¼ë§ˆ" : "ã‚ã„ã†ãˆãŠã‹";
            let choices = [...new Set([...cnTarget.split(''), ...pool.split('').sort(()=>Math.random()-0.5).slice(0, 5)])];
            choices.sort(()=>Math.random()-0.5).forEach(c => {
                const b = document.createElement('button'); b.className = "choice-btn"; b.innerText = c;
                b.onclick = () => { cnInput += c; document.getElementById('cnSpellDisplay').innerText = cnInput; };
                sPad.appendChild(b);
            });
        }
        function checkCnSpellAnswer() {
            if(cnInput === cnTarget) {
                document.getElementById('cnSpellFeedback').innerText = "âœ… æ­£ç¢ºï¼";
                speak(cnTarget); setTimeout(startCnSpellQuiz, 1500);
            } else {
                document.getElementById('cnSpellFeedback').innerText = "âŒ æ‡‰ç‚º: " + cnTarget;
            }
        }

        // --- å¾ªç’°æ’­æ”¾ ---
        function toggleAutoplay() { 
            isAutoplay = !isAutoplay; 
            if(isAutoplay) { repeatCount = 0; document.getElementById('autoBtn').innerText = "â¹ï¸ åœæ­¢"; playNextAuto(); }
            else stopAutoplay();
        }
        function stopAutoplay() { isAutoplay = false; clearTimeout(autoTimer); document.getElementById('autoBtn').innerText = "â–¶ï¸ é–‹å§‹å¾ªç’°"; }
        function playNextAuto() {
            if(!isAutoplay || filteredWords.length === 0) return;
            let w = filteredWords[autoIndex];
            if(currentLang === 'kr') {
                document.getElementById('auto-main').innerText = w.kr; document.getElementById('auto-sub').innerText = "";
            } else {
                document.getElementById('auto-main').innerText = w.jp; document.getElementById('auto-sub').innerText = `(${w.kana})`;
            }
            document.getElementById('auto-cn').innerText = w.cn;
            repeatCount++;
            document.getElementById('auto-repeat-info').innerText = `é‡è¤‡ ${repeatCount} / 3`;
            speak(currentLang === 'kr' ? w.kr : w.kana);
            if(repeatCount < 3) { autoTimer = setTimeout(playNextAuto, 2000); }
            else { repeatCount = 0; autoIndex = (autoIndex + 1) % filteredWords.length; autoTimer = setTimeout(playNextAuto, 3500); }
        }

        function updateCategoryMenu() { const menu = document.getElementById('cat-selector'); const cats = [...new Set(allWords.map(w => w.cat).filter(c => c))]; menu.innerHTML = '<option value="all">ğŸ“ å…¨éƒ¨å–®å­—</option>' + cats.map(c => `<option value="${c}">${c}</option>`).join(''); }
        function filterByCategory() { const selected = document.getElementById('cat-selector').value; filteredWords = (selected === 'all') ? allWords : allWords.filter(w => String(w.cat) === selected); if(!document.getElementById('page-review').classList.contains('hidden')) renderReview(); }
        function renderReview() { const list = document.getElementById('wordList'); list.innerHTML = filteredWords.map(w => `<div style="display:flex;justify-content:space-between;padding:12px;border-bottom:1px solid #eee;text-align:left;"><div><b>${currentLang==='kr'?w.kr:`${w.jp} (${w.kana})`}</b><br><small>${w.cn}</small></div><button onclick="speak('${currentLang==='kr'?w.kr:w.kana}')">ğŸ”Š</button></div>`).join(''); }
    </script>
</body>
</html>
